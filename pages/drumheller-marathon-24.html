---
permalink: drumheller-marathon-24/
redirect_from:
- /dhm/
- /drumheller-half/
- /dm/
- /drumheller-marathon/
- /dm24/
---
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Drumheller Marathon 2024</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Marathon and half marathon around Drumheller Fountain, June 1st, 2024.">
    <meta property="og:image" content="{{ site.url }}/img/dm24/og-banner.jpg">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ site.url }}/drumheller-marathon-24/">
    <meta property="og:title" content="Drumheller Marathon 2024">
    <meta property="og:description" content="Experience the fountain and the mountain. June 1st, 2024.">
    <link href="{{ site.baseurl }}/img/dm24/favicon.png" rel="icon" type="image/png"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" integrity="sha512-b2QcS5SsA8tZodcDtGRELiGv5SaKSk1vDHDaQRda0htPYWZ6046lr3kJ5bAAQdpV2mmA/4v0wQF9MyU6/pDIAg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Yrsa:ital,wght@0,300..700;1,300..700&family=Prompt:wght@400;700&display=swap"
          rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tabulator-tables/5.5.2/css/tabulator.min.css" integrity="sha512-HdUIebGeOK7s+At/fOnnbX8vsz6Cl1KTeiRlBiQABTMSqw7kZRCxGiUnuF9lr+1xz5y8pL7jkCR+NNtVVkEqKg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tabulator-tables/5.5.2/css/tabulator_bootstrap5.min.css" integrity="sha512-904y6HHQyQS2fAyIQ869rH3AAkxZeFuxo9vheji5zw+IPEyioMWN4Bt/VFhzO5edPZ9m1lwkpYgXcYcm1vzaFw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"
            integrity="sha512-M7nHCiNUOwFt6Us3r8alutZLm9qMt4s9951uo8jqO4UwJ1hziseL6O3ndFyigx6+LREfZqnhHxYjKRJ8ZQ69DQ=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/5.4.2/photoswipe.min.css" integrity="sha512-LFWtdAXHQuwUGH9cImO9blA3a3GfQNkpF2uRlhaOpSbDevNyK1rmAjs13mtpjvWyi+flP7zYWboqY+8Mkd42xA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe-dynamic-caption-plugin/1.2.7/photoswipe-dynamic-caption-plugin.min.css" integrity="sha512-x20LXbTUxAMuniBAuSyDGScWaoCxvZJ8m0tbJCRtpPkvPgsb2kStG9ZhDQKHj5mDWaKFOP7TadAZ4KVAyFJwNA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script type="importmap">
        {
          "imports": {
            "bootstrap": "https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.esm.min.js",
            "d3": "https://cdn.jsdelivr.net/npm/d3@7.9.0/+esm",
            "lit": "https://cdn.jsdelivr.net/gh/lit/dist@3/core/lit-core.min.js",
            "lit-html": "https://cdn.jsdelivr.net/gh/lit/dist@3/core/lit-core.min.js",
            "lit-element": "https://cdn.jsdelivr.net/gh/lit/dist@3/core/lit-core.min.js",
            "maplibre-gl": "https://cdnjs.cloudflare.com/ajax/libs/maplibre-gl/4.3.2/maplibre-gl.min.js",
            "p5": "https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.3/p5.min.js",
            "photoswipe": "https://cdnjs.cloudflare.com/ajax/libs/photoswipe/5.4.2/photoswipe.esm.min.js",
            "photoswipe-lightbox": "https://cdnjs.cloudflare.com/ajax/libs/photoswipe/5.4.2/photoswipe-lightbox.esm.min.js",
            "photoswipe-dynamic-caption": "https://cdnjs.cloudflare.com/ajax/libs/photoswipe-dynamic-caption-plugin/1.2.7/photoswipe-dynamic-caption-plugin.esm.min.js",
            "@popperjs/core": "https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.11.8/esm/popper.min.js",
            "tabulator-tables": "https://cdnjs.cloudflare.com/ajax/libs/tabulator-tables/5.5.2/js/tabulator_esm.min.js"
          }
        }
    </script>

    <style>
        :root {
            --branding-color: #3CB6BF;
            --branding-color-light: #aedce6;
            --branding-color-complement: #BD81C6;
            --branding-color-complement-light: #dface6;
            --branding-secondary-color: #B5AFA3;
            --branding-secondary-color-light: #D1CABD;
            --noise: url("{{ site.baseurl }}/img/dm24/noise.png");
            font-size: 21px;
            line-height: 1.5;

        }
        body {
            margin: 0;
            --bs-body-color: #111;
            --bs-link-color-rgb: 20, 20, 20;
            --bs-link-hover-color-rgb: 60, 60, 60;
            --bs-body-bg: #EFEFEF;
            --bs-body-font-family: 'Yrsa', serif;
            --bs-body-font-weight: 400;
            font-optical-sizing: auto;
            --sans-font-family: "Avenir Next", "Prompt", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif;
        }

        ::selection {
            background: var(--branding-color-light);
        }

        hr {
            width: 6rem;
            margin: 4rem auto;
            display: block;
            border: 1px solid #DDD;
        }

        ul, ol {
            /* Don't jam bullet at edge of screen on mobile */
            padding-left: 1rem
        }

        @media screen and (min-width: 700px) {
            ul:not(.no-hanging) {
                padding-left: 0;
            }
        }

        figure {
            max-width: 1200px;
            margin: 0 auto 2rem auto;
        }

        figure img {
            width: 100%;
        }

        .full-width {
            width: 100vw;
            position: relative;
            left: 50%;
            right: 50%;
            margin-left: -50vw;
            margin-right: -50vw;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 0 1rem
        }

        header {
            margin-bottom: 2rem;
        }

        header h1 {
            margin: 0;
            overflow: hidden;
        }

        section {
            margin-bottom: 4rem;
        }

        h1, h2, h3 {
            font-family: var(--sans-font-family);
            font-weight: 700;
            font-size: 1.2rem;
        }

        h3 {
            font-family: var(--bs-body-font-family);
            font-weight: 700;
            font-size: 1rem;
        }

        a.disabled {
            color: gray;
            pointer-events: none;
        }

        .inline-icon {
            height: 1em;
            vertical-align: middle;
            margin-left: -.2em;
        }

        .anchor-link {
            padding: 0 .175rem;
            font-weight: 400;
            color: var(--branding-secondary-color);
            text-decoration: none;
            opacity: 0;
            transition: color 0.15s ease-in-out,opacity 0.15s ease-in-out;
        }

        .anchor-link::after {
            content: "#";
        }

        .anchor-link:focus, .anchor-link:hover, :hover > .anchor-link, :target .anchor-link {
            text-decoration: none;
            opacity: 1;
        }

        /* HERO */

        #hero .display-text, #hero #overview {
            opacity: 0;
            animation: fade-in 1s ease forwards;
            animation-delay: 3.4s;
        }

        @keyframes fade-in {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes orbit {
            0% {}
            50% {transform: rotate(180deg);}
            100% {transform: rotate(360deg);}
        }

        @media (prefers-reduced-motion) {
            /* styles to apply if a user's device settings are set to reduced motion */
            #hero .imprint, #hero .date {
                animation: none;
            }
            .orbit {
                animation: none;
            }
        }


        #hero {
            max-width: 80rem;
            margin: 0 auto;
            padding: clamp(.75rem,min(5vh, 10vw),3rem) 1rem;
            overflow-x: clip; /* Allow underlay gradient to spill out */
        }

        #hero h1 {
            font-weight: 600;
            font-size: clamp(.75rem,min(8vh, 8vw),20rem);
            line-height: .9;
            font-family: var(--bs-body-font-family);
        }

        .display-text {
            font-size: clamp(.75rem,min(5vh, 5vw),10rem);
            line-height: 1;
            font-style: italic;
            font-weight: 300;
        }

        /* Interactive fountain */

        #hero-toy {
            display: block;
            margin: clamp(1.33rem, 4vh, 2rem) auto;
        }

        /* Suppress loading text shown when p5.js is used with a preload */
        #p5_loading {
            display: none;
        }
        .diagram {
            position: relative;
            --size: clamp(300px, min(80vw,65vh), 800px);
            --dot-width: clamp(5px, var(--size) * 0.01, 8px);
            --orbit-offset: calc(var(--dot-width) * 3);
            display: inline-block;
            width: var(--size);
        }

        .diagram .toy-overlay {
            width: 100%;
            height: 100%;
            position: absolute;
            z-index: 1;
            left: 0;
        }

        .jets {
            position: absolute;
            left: 50%;
            top: 50%;
            width: calc(var(--size) * .6);
            height: calc(var(--size) * .6);
            margin-left: calc(-.3 * var(--size));
            margin-top: calc(-.3 * var(--size));
            z-index: 2;
            pointer-events: none;
        }
        .clickable-circle {
            clip-path: circle(47.5%);
            cursor: pointer;
        }

        .ring {
            position: relative;
            left: 50%;
            margin-left: calc(-.5 * var(--size));
            height: calc(var(--size));
            width: calc(var(--size));
        }

        .dot {
            position: absolute;
            height: calc(var(--size) + 2 * var(--orbit-offset));
            width: var(--dot-width);
            top: calc(-.5 * var(--dot-width) - var(--orbit-offset));
            left: 50%;
            margin-left: calc(-.5 * var(--dot-width));

        }
        .dot span {
            display: block;
            height: var(--dot-width);
            width: var(--dot-width);
            border-radius: 50%;
            background-color: black;
        }

        .wavy-button {
            text-decoration-thickness: .5px;
            text-decoration-style: wavy;
            text-decoration-color: var(--branding-color);
            font-style: italic;
            text-underline-offset: 2px;
        }

        .wavy-button.complement-color {
            text-decoration-color: var(--branding-color-complement);
        }

        .wavy-button.disabled {
            text-decoration-color: var(--branding-color-light);
        }

        .orbit {
            opacity: 0;
            animation: fade-in 1s ease forwards, orbit 60s linear infinite;
            transform-style: preserve-3d;
        }

        .orbit.one {
            animation: fade-in 1s ease forwards, orbit 53s linear infinite;
            animation-delay: .5s, 0s;
        }

        .orbit.two {
            animation: fade-in 1s ease forwards, orbit 67s linear infinite;
            animation-delay: 2.3s, 0s;
        }

        .orbit.three {
            animation: fade-in 1s ease forwards, orbit 61s linear infinite;
            animation-delay: 2.5s, 0s;
        }

        .orbit.four {
            animation: fade-in 1s ease forwards, orbit 59s linear infinite;
            animation-delay: 2.7s, 0s;
        }

        .rotation-offset {
            width: 100%;
            height: 100%;
        }

        .orbit.two > .rotation-offset {
            transform: rotate(150deg);
        }

        .orbit.three > .rotation-offset {
            transform: rotate(200deg);
        }

        .orbit.four > .rotation-offset {
            transform: rotate(265deg);
        }

        #underlay-gradient {
            position: absolute;
            width: 180%;
            height: 180%;
            left: -40%;
            top: -40%;
            z-index: -1;
            background:
                    radial-gradient(#d5d5d5 30%, transparent 70%);
            mask: var(--noise), radial-gradient(black 20%, transparent 60%);
        }

        /* Section specific */


        .imprint {
            text-align: center;
            margin-bottom: 1.5rem;
            font-weight: 300;
        }

        .imprint a {
            text-decoration: none;
            color: #333;
            transition: .3s;
        }

        .imprint a:hover {
            color: #bbb;
        }

        .imprint img {
            width: 100px;
            opacity: .5;
            transition: .3s;
        }

        .imprint:hover img {
            opacity: .8;
        }

        #overview {
            max-width: 500px;
            margin: 0 auto;
            text-align: center;
            margin-bottom: 4rem;
        }

        .lede {
            font-style: italic;
        }

        #course-map {
            border-radius: 1rem;
            display: block;
            margin: 0 auto;
            margin-bottom: 1rem;
            max-height: 120vh;
            /* Max height works fine in FF, but Safari will
       draw a full width white background box. Setting contain gets rid of the visible box, but the element
       box remains too big and the border radius won't render...
     */

            /*object-fit: contain;*/
        }

        .accordion {
            --bs-accordion-btn-focus-border-color: #bbb;
            --bs-accordion-btn-focus-box-shadow: 0 0 0 0.25rem var(--branding-secondary-color);
            --bs-accordion-border-radius: .5rem;
            --bs-accordion-inner-border-radius: .5rem;
            --bs-accordion-body-padding-x: 1rem;
            --bs-accordion-body-padding-y: .75rem;
            --bs-accordion-btn-padding-x: 1rem;
            --bs-accordion-btn-padding-y: .75rem;
            --bs-accordion-bg: var(--bs-body-bg);
            --bs-accordion-color: var(--bs-body-color);
            --bs-accordion-active-color: var(--bs-emphasis-color);
            --bs-accordion-active-bg: var(--branding-secondary-color-light);
            --bs-accordion-btn-icon-width: 1rem;
            --bs-accordion-border-color: #ccc;
        }

        .accordion-header button {
            font-size: 21px;
            font-family: var(--bs-body-font-family);
            font-weight: 600;
        }

        .accordion-button::after {
            filter: saturate(0%);
        }


        .blockquote {
            font-style: italic;
            font-size: 1rem;
        }

        .blockquote-footer {
            color: #888;
        }

        footer {
            margin: 6rem 0 6rem 0;
        }

        #epilogue {
            margin-top: 4rem;
            padding-top: 4rem;
        }

        #epilogue .container {
            margin-bottom: 2rem;
        }

        #epilogue h1 {
            margin-bottom: 2rem;
        }


        /* Certs */

        .cert-wrapper {
            display: flex;
            justify-content: center;
        }

        .usatf-certificate {
            font-size: .66rem;
            font-family: var(--sans-font-family);
            border: 2px solid #999;
            border-radius: .75rem;
            display: inline-flex;
            gap: 1rem;
            flex-direction: row;
            justify-content: center;
            margin-bottom: 0;
            padding: .75rem .75rem;
            text-decoration: none;
            color: #666;
            transition: .3s;
        }

        .usatf-certificate:hover {
            color: black;
            border: 2px solid #333;
        }

        .usatf-certificate.full:hover {
            border: 2px solid var(--branding-color);
        }

        .usatf-certificate.half:hover {
            border: 2px solid var(--branding-color-complement);
        }

        .usatf-certificate:hover img {
            opacity: 1;
        }

        .usatf-certificate img {
            height: 4rem;
            opacity: .6;
            transition: .3s;
        }

        .usatf-certificate .details {
            align-self: center;
        }

        .usatf-certificate h2,
        .usatf-certificate p {
            font-size: inherit;
            margin-bottom: 0;
        }

        /* Results */

        .table {
            background: transparent;
            width: auto;
            min-width: 200px;
            font-size: 21px;
            line-height: 36px;
        }

        .table th {

        }

        .table tr td {
            border-bottom-width: 0;
        }

        .table thead {
            border-bottom-width: 1px;
        }

        .result-detail {
            padding: 1rem;
        }

        .pswp-caption-content, .pswp__dynamic-caption {
            font-weight: 300;
        }

        track-map {
            display: block;
            margin: 0 auto;
            max-width: 100%;
            height: min(max(50vh, 300px), 400px);
        }

        .tabulator {
            font-size: 1rem;
        }

        .tabulator,
        .tabulator .tabulator-header .tabulator-col,
        .tabulator .tabulator-header,
        .tabulator .tabulator-tableholder .tabulator-table,
        .tabulator .tabulator-footer {
            background-color: transparent;
        }

        .tabulator-row.tabulator-group {
            background-color: rgba(255, 255, 255, 0.075) !important;
        }

        .tabulator .tabulator-tableholder .tabulator-table .tabulator-row.tabulator-calcs {
            background-color: transparent !important;
        }

        .tabulator-row, .tabulator-row.tabulator-row-even {
            background-color: transparent;
        }

        .tabulator-row.details-opened.tabulator-selectable,
        .tabulator .tabulator-header .tabulator-col.tabulator-sortable.tabulator-col-sorter-element {
            transition: .2s;
        }

        .tabulator .tabulator-header .tabulator-col.tabulator-sortable.tabulator-col-sorter-element:hover {
            background-color: rgba(255, 255, 255, .3);
        }

        .tabulator-row.tabulator-selectable:hover {
            background-color: rgba(255, 255, 255, .3);
        }

        .tabulator-row.details-opened.tabulator-selectable,
        .tabulator-row.details-opened.tabulator-selectable:hover {
            background-color: #111;
        }

        .tabulator .tabulator-header {
            border-top: none;
        }

        .laps-table {
            padding: 1rem;
        }

        .tabulator .tabulator-tableholder .tabulator-table .tabulator-row.tabulator-calcs.tabulator-calcs-bottom {
            border-top: 2px solid #999;
        }

        .laps-table.tabulator .tabulator-header {
            border-bottom: 1px dashed #999;
        }

        .laps-table .tabulator-row {
            border-bottom: 1px dashed #999;
        }

        .laps-table .tabulator-row .tabulator-cell {
            padding: 4px;
        }
        .laps-table.tabulator .tabulator-tableholder .tabulator-table .tabulator-row.tabulator-calcs.tabulator-calcs-bottom {
            border-top: 1px dashed #999;
            border-bottom: none;
        }

        .tabulator-row.tabulator-group {
            border-top: 1px dashed #999;
            border-right: none;
        }

        .tabulator-row.tabulator-group:first-of-type {
            /* Hide the "official laps" header */
            display: none;
        }

        .laps-table .tabulator-footer {
            border-top: 1px dashed #999;
            border-bottom: none;
        }

        .tabulator-tableholder, .tabulator-table {
            max-width: 100%;
        }

        .bib {
            font-weight: 600;
            background-color: black;
            color: white;
            font-family: var(--sans-font-family);
            border-radius: .25rem;
            display: inline-block;
            padding: 0 .25rem;
            font-size: .75rem;
        }
        .bib.full, .full.form-check-input:checked {
            background-color: var(--branding-color);
        }
        .bib.half, .half.form-check-input:checked {
            background-color: var(--branding-color-complement);
        }

        .full.form-check-input:checked {
            background-color: var(--branding-color);
            border-color: var(--branding-color)
        }
        .half.form-check-input:checked {
            background-color: var(--branding-color-complement);
            border-color: var(--branding-color-complement)
        }

        .full.form-check-input:focus {
            border-color: var(--branding-color);
            box-shadow: 0 0 0 .25rem var(--branding-color-light);
        }

        .half.form-check-input:focus {
            border-color: var(--branding-color-complement);
            box-shadow: 0 0 0 .25rem var(--branding-color-complement-light);
        }

        .form-control:focus {
            border-color: var(--branding-color);
            outline: 0;
            box-shadow: 0 0 0 .25rem var(--branding-color-light);
        }

        .input-group-text {
            background-color: var(--bs-gray-400);
        }
        .beta-badge {
            font-size: .66rem;
            vertical-align: top;
            font-weight: 400;
            border-radius: .25rem;
        }
    </style>
</head>

<body>

<header id="hero" class="text-center">
    <div class="display-text">The <a href="{{ site.baseurl }}/" class="text-decoration-none">Race Condition Running</a> <h1>Drumheller&nbsp;Marathon</h1> will run June&nbsp;1st,&nbsp;2024.</div>

    <div class="diagram" id="hero-toy">
        <img src="{{ site.baseurl }}/img/dm24/jets-grad.svg" alt="" class="jets"/>
        <img src="{{ site.baseurl }}/img/dm24/basin.svg" alt="" class="toy-overlay">
        <div class="interactive toy-overlay clickable-circle"></div>
        <div class="ring">
            <div class="dot one orbit"><div class="rotation-offset"><span class="pulse" data-n="0"></span></div></div>
            <div class="dot two orbit"><div class="rotation-offset"><span class="pulse" data-n="1"></span></div></div>
            <div class="dot three orbit"><div class="rotation-offset"><span class="pulse" data-n="2"></span></div></div>
            <div class="dot four orbit"><div class="rotation-offset"><span class="pulse" data-n="3"></span></div></div>
        </div>
        <div id="underlay-gradient"></div>
    </div>
    <div id="overview">
        <div class="col-12">
            <p class="lede">Join us for laps around UW's historic fountain</p>
        </div>

        <div class="gap-2 row justify-content-center mb-4">

        <div class="col-auto">
            <a class="wavy-button disabled" href="https://forms.gle/BhJpHUGZSfjRMNds5" data-bs-toggle="tooltip" data-bs-title="Closed 5-1" data-bs-placement="bottom">Apply for Full</a>
            <div>5:30AM</div>
        </div>
        <div class="col-auto">
            <a class="wavy-button complement-color" href="https://forms.gle/BhJpHUGZSfjRMNds5" data-bs-toggle="tooltip" data-bs-title="by 5-29" data-bs-placement="bottom">Register for Half</a>
            <div>8:00AM</div>
        </div>


            <!--<a class="btn btn-lg hero-button" href="#epilogue">Read Epilogue</a>-->

        </div>
        <div class="row justify-content-center">
            <div class="col-auto">
                <a class="wavy-button" href="https://forms.gle/GroYX6gFR88b4rqb6">Order a Shirt</a>
            </div>
        </div>
    </div>

</header>


<section id="course">
    <div class="container">
        <h2>Course <a href="#course" class="anchor-link" aria-label="Link to this section. Course"></a></h2>
        <p>The course consists of a short segment down the upper vista followed by laps around Drumheller Fountain and the <a href="https://facilities.uw.edu/blog/posts/2016/04/05/drumheller-duckling-debut">duck ramp <img src="{{ site.baseurl }}/img/dm24/duck-icon.svg" class="inline-icon"/></a>.  The marathon comprises 219 laps and the half marathon consists of 109 laps. Both events will start at different times and locations. Participants aiming for fewer laps should start with the half marathon.</p>

        <p>The
            direction will flip every hour, and you must change directions only by rounding the marker placed
            at the edge of the finish line. We cannot provide you an official time unless you follow these instructions and complete the necessary number of laps.</p>

        <p>While campus activity is reduced on weekends, expect to navigate around fountain-admirers, passers-by and
            cyclists. The course is not closed.</p>

        <h3>Etiquette</h3>

        <ul class="no-hanging">
            <li>Run in the inner lane along the curb</li>
            <li>Do not run more than two wide</li>
            <li>Pass on the outside unless the other runner yields</li>
            <li>Walk or stop along the outside of the loop only</li>
        </ul>

            <div class="map-item">
                <img id="course-map" src="{{ site.baseurl }}/img/dm24/dm-course-map-alt.svg"
                         alt="A map of the course showing the full start line 129.17m north of the fountain and the half start line 65.97m north of the fountain, followed by 219 or 109 laps of the 192.37m fountain loop.">

                <div class="d-flex justify-content-center gap-2 gap-md-4 flex-column flex-md-row">
                    <div class="cert-wrapper">
                        <a class="usatf-certificate full" href="https://certifiedroadraces.com/certificate/?type=m&id=3255">
                            <img src="{{ site.baseurl }}/img/dm24/usatf-certified-course-black.svg" alt=""/>
                            <div class="details">
                                <h2>USATF Certificate</h2>
                                <span>WA24018RMB</span>
                                <p><b>Effective</b>: 4/17/24<br/>
                                    <b>Through</b>: 12/31/34</p>
                            </div>
                        </a>
                    </div>
                    <div class="cert-wrapper">
                        <a class="usatf-certificate half" href="https://certifiedroadraces.com/certificate/?type=m&id=3253">
                            <img src="{{ site.baseurl }}/img/dm24/usatf-certified-course-black.svg" alt=""/>
                            <div class="details">
                                <h2>USATF Certificate</h2>
                                <span>WA24016RMB</span>
                                <p><b>Effective</b>: 4/17/24<br/>
                                    <b>Through</b>: 12/31/34</p>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>

</section>

<section>
    <div id="travel" class="container">
        <h2>Travel <a href="#travel" class="anchor-link" aria-label="Link to this section. Travel"></a></h2>
        <p>The course is served by the <a href="https://www.soundtransit.org/ride-with-us/stops-stations/university-washington-station?route_tab=arrivals">University of Washington light rail station</a>. <a href="https://www.soundtransit.org/ride-with-us/1-line-service-disruption">Minor service disruptions</a> will be in effect on June 1st. <a href="https://seattletransitmap.com/app/">Many bus routes</a> stop at UW station or U District station.</p>
        <p>Central Plaza Garage (CPG) beneath Red Square is the closest parking. See the <a href="https://transportation.uw.edu/park/visitor/self-serve">University's page</a> for rates and instructions.</p>
    </div>
</section>

<section>
    <div class="container">
        <h2 id="race-day">Race Day <a href="#race-day" class="anchor-link" aria-label="Link to this section. Race Day"></a></h2>
        <ul>
            <li>Bring a water bottle</li>
            <li>Be at the start line 10 minutes early for course instructions and a photo</li>
        </ul>
        <h3>Schedule</h3>
        <ul>
            <li>5:30AM: Full start</li>
            <li>6:00AM: Early Half start (target <1:40 finish time)</li>
            <li>8:00AM: Half start</li>
            <li><i>20 minutes after last Full finisher</i>: Full awards and photo</li>
            <li>11:00AM: Course closes, group photo</li>
        </ul>
    </div>
</section>

<section id="live-tracking">
    <div class="container">
        <h2 class="mb-3"><connection-dot></connection-dot> Live Tracking <span class="badge text-bg-secondary beta-badge">Beta</span> <a href="#live-tracking" class="anchor-link" aria-label="Link to this section. Live Tracking"></a></h2>
        <div id="live-map">
            <table-filter-manager>
            </table-filter-manager>
            <track-map data-center="[-122.307806, 47.653860]" data-start-angle="1.7" data-bounds="[[[-122.307824, 47.654168], [-122.307876, 47.654166], [-122.307928, 47.654161], [-122.307978, 47.654152],
  [-122.308027, 47.65414], [-122.308075, 47.654125], [-122.30812, 47.654107], [-122.308162, 47.654086],
  [-122.3082, 47.654063], [-122.308235, 47.654036], [-122.308266, 47.654008], [-122.308293, 47.653978],
  [-122.308316, 47.653946], [-122.308333, 47.653913], [-122.308346, 47.653879], [-122.308354, 47.653844],
  [-122.308356, 47.653809], [-122.308354, 47.653774], [-122.308346, 47.653739], [-122.308333, 47.653705],
  [-122.308316, 47.653672], [-122.308293, 47.65364], [-122.308266, 47.65361], [-122.308235, 47.653581],
  [-122.3082, 47.653555], [-122.308162, 47.653532], [-122.30812, 47.653511], [-122.308075, 47.653493],
  [-122.308027, 47.653478], [-122.307978, 47.653466], [-122.307928, 47.653457], [-122.307876, 47.653452],
  [-122.307824, 47.65345], [-122.307772, 47.653452], [-122.30772, 47.653457], [-122.307669, 47.653466],
  [-122.30762, 47.653478], [-122.307573, 47.653493], [-122.307528, 47.653511], [-122.307486, 47.653532],
  [-122.307447, 47.653555], [-122.307412, 47.653581], [-122.307381, 47.65361], [-122.307354, 47.65364],
  [-122.307332, 47.653672], [-122.307314, 47.653705], [-122.307301, 47.653739], [-122.307294, 47.653774],
  [-122.307291, 47.653809], [-122.307294, 47.653844], [-122.307301, 47.653879], [-122.307314, 47.653913],
  [-122.307332, 47.653946], [-122.307354, 47.653978], [-122.307381, 47.654008], [-122.307412, 47.654036],
  [-122.307447, 47.654063], [-122.307486, 47.654086], [-122.307528, 47.654107], [-122.307573, 47.654125],
  [-122.30762, 47.65414], [-122.307669, 47.654152], [-122.30772, 47.654161], [-122.307772, 47.654166],
  [-122.307824, 47.654168]]]"></track-map>
            <div id="lap-table"></div>
            <lap-table></lap-table>
            <p class="small fst-italic text-muted">Tracking data are not official results</p>
        </div>

        <accordion-group id="live-tracking-accordion">
            <accordion-item>
                <accordion-header>About</accordion-header>
                <accordion-body>
                    <p>The <a href="https://owntracks.org/">OwnTracks</a>-powered live tracking system uses your phone to report location data to a server. This page processes that data to display an estimated lap count.</p>

                    <p class="alert alert-warning">
                        <b>Caveat emptor:</b> Test with your device before the race. Do not depend on live tracking counts.
                    </p>

                    <h3>Usage</h3>
                    <ul class="no-hanging">
                        <li>This page displays only today's data</li>
                        <li>Lap counts are fractional and ignore direction and start/end location</li>
                        <li>Your location displays as a marker while you're on the course</li>
                        <!--li>Click on a row in the table to display history and estimated lap information</li-->
                        <li>Rows show a warning icon ⚠️ if they contain frequent GPS errors greater than 20m. Check your configuration, and keep your phone in an outer pocket if possible.</li>
                    </ul>

                    <h3>Privacy</h3>
                    <ul class="no-hanging">
                        <li>The client app reports GPS, WiFi/cellular, and battery percentage information</li>
                        <li>Only information collected from within the course region will be stored</li>
                        <li>Information is available publicly and identifiably until the day after the event</li>
                        <li>We may retain information indefinitely to help improve the system in the future</li>
                        <li>We may release de-identified versions of your data in the future</li>
                    </ul>

                </accordion-body>
            </accordion-item>
            <accordion-item>
                <accordion-header>Phone Setup</accordion-header>
                <accordion-body>
                    <ol class="no-hanging">
                        <li>Install the client app for <a href="https://itunes.apple.com/us/app/mqttitude/id692424691?mt=8">iOS</a> or <a href="https://play.google.com/store/apps/details?id=org.owntracks.android">Android</a>. The app requires all the location permissions it prompts for, including the ability to run in the background. It will silently fail if they aren’t granted.
                        <ul>
                            <li>iOS: You can review the app's location permissions in Settings > Privacy & Security > Location Services</li>
                        </ul>
                        </li>
                        <li>Use your phone's camera app to scan the QR code you were emailed to configure the OwnTracks app.</li>
                        <li>Go to the course, open the app on your phone, and ensure the UI says “Move” (over the map on iOS, behind a play button on Android). All the app does is transmit data, so <i>it does not display your lap count</i>. You will only be able to see your information on this webpage.</li>
                        <li>Run around the fountain, check that you appear on this page, and check that your lap number increases</li>
                        <li>Every lap will be counted, so for race-day we recommend you only open up OwnTracks when you're on the start line.</li>
                        <li>Kill the app or uninstall it when you are done testing or racing</li>
                    </ol>
                    <p class="alert alert-info">
                        <b>Troubleshooting:</b> If your marker appears on the map then grays out, your phone may only be transmitting while the app is foregrounded. See the above note on iOS for providing background ("Always Allow") location access.
                    </p>
                </accordion-body>
            </accordion-item>
        </accordion-group>
    </div>
</section>

<section>
    <div id="faq" class="container">
        <h2>FAQ <a href="#faq" class="anchor-link" aria-label="Link to this section. FAQ"></a></h2>

        <accordion-group id="faq-accordion">
            <accordion-item>
                <accordion-header>Do I have to run the whole thing?</accordion-header>
                <accordion-body>
                        <p>No. Anyone running or walking fewer than 109 laps is welcome to join the half marathon. Here are some lap counts for common distances. Add a lap if not starting at the official start line.</p>
                        <table class="table table-sm ms-2 mt-2 mb-4">
                            <thead><tr><th scope="col">Distance</th><th scope="col">Laps</th></tr></thead>
                            <tbody>
                            <tr><td>5k</td> <td>26</td></tr>
                            <tr><td>10k</td> <td>52</td></tr>
                            <tr><td>10mi</td><td>83</td></tr>
                            </tbody>
                        </table>

                        <p>Excepting pacers, <i>full marathon</i> participants must intend to complete the full distance.</p>
                </accordion-body>
            </accordion-item>
            <accordion-item>
                <accordion-header>How fast do I need to run?</accordion-header>
                <accordion-body><p>The cutoff times and corresponding average paces are:</p>
                    <table class="table table-sm ms-2 mt-2 mb-4">
                        <thead><tr><th>Distance</th><th>Time</th><th>min/mi</th> <th>min/km</th></tr></thead>
                        <tbody>
                        <tr><td>Marathon</td> <td>4:30:00</td> <td>10:18</td> <td>6:24</td></tr>
                        <tr><td>Half Marathon</td> <td>3:00:00</td> <td>13:43</td> <td>8:31</td></tr>
                        </tbody>
                    </table>
                </accordion-body>
            </accordion-item>

            <accordion-item>
                <accordion-header>What's the weather like?</accordion-header>
                <accordion-body>

                    <blockquote class="blockquote">On June 1, the temperature in Seattle typically ranges from 53°F to 66°F and is rarely below 48°F or above 76°F.
                        [...]
                        The coolest time of the day is from 1:00 AM to 8:00 AM, with the coldest at 5:30 AM, at which time the temperature is below 55°F three days out of four, and below 58°F nine days out of ten.
                        [...]
                        The cloudiest time of day is around 6:30 AM, at which time the chance of overcast or mostly cloudy conditions is 58%.
                    </blockquote>
                    <p class="blockquote-footer"><a href="https://weatherspark.com/d/913/6/1/Average-Weather-on-June-1-in-Seattle-Washington-United-States#Figures-Temperature">June 1 Weather in Seattle, Weather Spark</a></p>
                </accordion-body>
            </accordion-item>

            <accordion-item>
                <accordion-header>Is there gear check?</accordion-header>
                <accordion-body><p>You can stash a bag near the aid station. You'll have line of sight the whole race, but they won't be attended.</p>
                </accordion-body>
            </accordion-item>

            <accordion-item>
                <accordion-header>How do we keep track of distance?</accordion-header>
                <accordion-body><p>Use a running watch to mark laps if you're wearing one, though you should check that it is capable of handling 100+ laps. GPS will clip the curve, so don't rely on it for more than a couple
                        laps at a
                        time.
                        We'll have <a href="https://en.wikipedia.org/wiki/Tally_counter">tally counters</a> available if
                        you
                        prefer an analog counting aide.</p>


                    <p>Counting without assistance is not recommended.</p>
                </accordion-body>
            </accordion-item>

            <accordion-item>
                <accordion-header>Which direction do we run?</accordion-header>
                <accordion-body>
                        <p>The race will begin counterclockwise and alternate directions every hour to help balance the strain across your legs. Having the field run a single direction at a time will help us manage course congestion. Change directions only at the end of a lap and only by rounding the finish line marker.</p>
                </accordion-body>
            </accordion-item>

            <accordion-item>
                <accordion-header>How is the event being timed?</accordion-header>
                <accordion-body>
                    <p>Official times will be determined using a recorded video. It is critical that you run at least the required number of laps to ensure we can provide you an official time.</p>
                    <p>Finalizing the results can take weeks. Please use the live tracking system so that you can receive an unofficial time immediately, and to make it easier for us to mark times.</p>
                </accordion-body>
            </accordion-item>

            <accordion-item>
                <accordion-header>Why do I have to apply for the marathon?</accordion-header>
                <accordion-body>
                        <p>We can't guarantee spots until we know the overall makeup of the field. Here are some of the things we're taking into account:</p>
                        <ol>
                            <li>We will only host the marathon distance if there are at least 3 registered participants who will start the race. <b>As of March 1st, the minimum field size is met.</b></li>
                            <li>If target times are highly disparate, we will need to test paces and plans on our compact course. If we cannot support all runners' plans, we will discuss compromises.</li>
                            <li>We will connect any participants targeting similar goals so that they can coordinate pacing plans. The more people that want to run similar paces, the more people that can participate.</li>
                            <li>We will not accept more runners than can have a good experience on our small course. If we need to be selective, we will judge based on evidence of preparedness in the form of prior race results and of commitment in the form of reasonable plans.</li>
                        </ol>
                        <p>Our goal is to confirm all applications by April 6th. We may close applications before then if the field fills.</p>
                </accordion-body>
            </accordion-item>

            <accordion-item>
                <accordion-header>Is it okay if I've never run a full marathon before?</accordion-header>
                <accordion-body>
                        <p>Maybe. The answer will depend on your background, so please discuss with the organizers first if you would like to plan on Drumheller being your first marathon. As a rule of thumb, if you have not yet successfully completed a half marathon, you will have a better time doing that instead.</p>

                </accordion-body>
            </accordion-item>

            <accordion-item>
                <accordion-header>Are pacers allowed?</accordion-header>
                <accordion-body>
                        <p>Yes. Runners intending to use pacers must submit a pacing plan with their application. Pacers can register after approval. Unlike most road races, we expect to be able to support rotating/non-starting pacers, however official times will only be given to participants who run the complete course.</p>
                    </accordion-body>
            </accordion-item>


            <accordion-item>
                <accordion-header>Can I take breaks?</accordion-header>
                <accordion-body>
                        <p>Yes. In addition to the aid station there are benches surrounding the course. You must continue running the lap in the same direction as when you stopped or the lap will not count. To remove this possibility, we recommend you start and stop only on at the lap finish line so you can begin the next lap in either direction.</p>
                    </accordion-body>
            </accordion-item>

            <accordion-item>
                <accordion-header>Why is the marathon start time so early?</accordion-header>
                <accordion-body>
                    <p>The half marathon field is larger and includes a broader range of paces, so we are scheduling to minimize the overlap between the two events. We plan under the assumption that the day will be warm with clear skies (the odds of this are something like 30%). We cannot start the half marathon much later than 8:00AM as we want those runners (many running their first half) to wrap up before the heat and sun pick up around 10:30AM. We may shift the start times if the forecast for the day is favorable. Note that the <a href="https://www.soundtransit.org/sites/default/files/documents/schedule-link-1-line.pdf">first trains start arriving</a> to University of Washington Link station around 5:00AM on Saturdays.</p>
                </accordion-body>
            </accordion-item>

            <accordion-item>
                <accordion-header>Is this a Boston Qualifying race?</accordion-header>
                <accordion-body>
                        <p>Yes, the full marathon will meet the B.A.A. criteria for a qualifying race (see <a href="https://www.baa.org/sites/default/files/2021-08/Boston_Marathon_Rules_and_Policies_08_2021.pdf">Rules and Policies</a> pp.5-6 &sect;2.2.1).</p>
                    </accordion-body>
            </accordion-item>

            <accordion-item>
                <accordion-header>Isn't running a continuous curve going to slow me down?</accordion-header>
                <accordion-body>
                        <p>Yes, but not substantially. You will need to supply an additional centripetal force due to the curve, but the effect of this is <a
                            href="https://blog.stryd.com/2020/01/09/how-much-time-do-you-lose-due-to-curves-and-turns/">likely less than 1% when running at world record marathon pace on a 30m radius</a>. Because the force increases in the square of velocity, the effect is negligible for recreational runners. There are individual differences in running technique and physiology that may make the effect more or less pronounced for you. Consider practicing on the course or a track.</p>
                    </accordion-body>
            </accordion-item>

            <accordion-item>
                <accordion-header>Will running a continuous curve for dozens of laps injure me?</accordion-header>
                <accordion-body>
                        <p>Unlikely. Many athletes train and race on smaller radius tracks without issue during indoor track season. There <i>is</i> <a href="https://doi.org/10.1097/00042752-200010000-00004">evidence</a> that consistently running the same direction on small indoor tracks over time leads to strength asymmetries which likely cause injuries. Alternating directions introduces rest and is probably sufficient to avoid acute issues for most runners.</p>

                        <p>You may also take comfort from knowing that <a href="https://www.outsideonline.com/health/running/inside-bizarre-world-indoor-marathons/">indoor track marathons have been held for years without event</a>.</p>
                    </accordion-body>
            </accordion-item>

            <accordion-item>
                <accordion-header>What if I'm late?</accordion-header>
                <accordion-body><p>Run from the start line and join us! You must enter the course from "behind" the finish line in the direction that the field is running at the time you join. So, if we're running counterclockwise, start your first loop by crossing over the finish line from the east, and otherwise from the west. Note that this event is <a href="https://www.runnersworld.com/training/a20793329/chip-time-vs-gun-time/">gun time</a> only.</p>

                </accordion-body>
            </accordion-item>
        </accordion-group>
    </div>
</section>

<hr/>

<section id="history">
    <figure class="gallery">
        <a href="https://files.nickwalker.us/aype.avif" class="lightbox" data-pswp-width="3000" data-pswp-height="2389">
            <!-- FIXME: Track in repo when image is done src="{{ site.baseurl }}/img/dm24/aype-thumb.webp"-->
            <img src="{{ site.baseurl }}/img/dm24/aype-thumb.webp"
                 alt="View of the Alaska-Yukon-Pacific Exposition, 1909"
                 class="w-100 shadow-1-strong rounded"/>

        </a>
        <figcaption class="pswp-caption-content">Rainier Vista during the 1909 Alaska-Yukon-Pacific Exposition. The
            photographer composited two images, resulting in the larger-than-life mountain. This scan has been retouched
            to remove damage from the original negative. <i>University of Washington Libraries, Special Collections,
                Frank H.
            Nowell, photographer, Nowellx1040a</i></figcaption>
    </figure>
    <div class="container">

        <figure>
        <blockquote class="blockquote">Rainier Vista, partly framed by Johnson and Mary Gates halls, is the most sacred space on campus.
            The vista was first conceived as a centerpiece of the campus plan by the Olmsted Brothers in 1906, when the
            elusive mountain revealed itself during the firm's visit to Seattle to develop a plan for the Alaska-Yukon-Pacific Exposition. Rainier
            Vista is the most dramatic borrowing from nature on any campus in the United
            States, with Mount Rainier as its climax, and with both architecture and landscape reinforcing its thrust
            past a minor view of the city toward the mountain beyond. As Edmond Meany put it, &#8220;No campus in all the
            world can equal Rainier Vista. In those rare moments when Mother Nature in kindly mood pulls aside the
            vaporous curtains we may gaze upon Mt. Rainier, a three-mile…flow…of rock and ice. A spectacle of unending
            fascination!&#8221;
        </blockquote>
        <figcaption class="blockquote-footer">Norman J. Johnston, <cite title="The Fountain and the Mountain">The Fountain and the Mountain</cite>
        </figcaption>
        </figure>

    </div>
</section>


<footer>
    <p class="imprint"><a href="{{ site.baseurl }}/"><img src="{{ site.baseurl }}/img/happy-toast.svg" alt="A happy piece of toast who is running"/></a></p>

    <ul class="list-unstyled d-flex justify-content-center gap-3 opacity-50 font-weight-light">
        <li><a href="{{ site.baseurl }}/dm24">2024</a></li>
        <li><a href="{{ site.baseurl }}/dhm23">2023</a></li>
        <li><a href="{{ site.baseurl }}/dhm22">2022</a></li>
    </ul>
</footer>

<script type="module">
    import {FountainToy} from "{{ site.baseurl }}/js/fountain/fountainToy.js";
    import {TrackMap} from "{{ site.baseurl }}/js/dm24/TrackMap.js";
    import {TableFilterManager} from "{{ site.baseurl }}/js/dm24/TableFilterManager.js";
    import {LapTable} from "{{ site.baseurl }}/js/dm24/LapTable.js";
    import {LiveTrackingClient} from "{{ site.baseurl }}/js/dm24/LiveTrackingClient.js";
    import {prepareImagesForPhotoswipe} from "{{site.baseurl}}/js/common.js";
    import PhotoSwipeLightbox from 'photoswipe-lightbox';
    import PhotoSwipeDynamicCaption from 'photoswipe-dynamic-caption';
    import {Tooltip} from 'bootstrap'
    import {} from 'p5'

    import {AccordionGroup, AccordionItem, AccordionHeader, AccordionBody} from '{{ site.baseurl }}/js/accordion.js';
    import {Tabulator, ColumnCalcsModule, GroupRowsModule, FormatModule, InteractionModule, ResizeColumnsModule, ResizeTableModule, ResponsiveLayoutModule, SortModule, SelectRowModule, ReactiveDataModule, FilterModule} from 'tabulator-tables';

    Tabulator.registerModule([ColumnCalcsModule, FormatModule, GroupRowsModule, InteractionModule, ResizeColumnsModule, ResizeTableModule, ResponsiveLayoutModule, SortModule, SelectRowModule, ReactiveDataModule, FilterModule]);

    const startDistances = {"full": 129.17, "half": 65.97};
    const goalLaps = {"full": 219, "half": 109};
    const loopDistance = 192.37;

    function formatTimeSince(seconds) {
        const remainingSeconds = seconds % 60;
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);
        if (days > 0) {
            return `${days}d ${hours % 24}h ago`;
        } else if (hours > 0) {
            return `${hours}h ago`;
        } else if (minutes > 0){
            return `${minutes}m ago`;
        } else if (seconds < 10) {
            return 'now'
        } else {
            return `${seconds}s ago`;
        }
    }

    function bibToEvent(bib) {
        // Bib's are two hex digits
        return parseInt(bib, 16) >= parseInt("F0", 16) ? 'full' : 'half';
    }

    function calculateWindingNumberAndAngularVelocity(track, center, startAngle=0.0) {
        // Use `startAngle` to make the lap start be at angle 0.0
        let totalAngle = 0.0;
        const angularVelocities = [];
        // Winding number is the (real-valued) number of times the curve winds around the center, where positive is counterclockwise
        const relWindingNumbers = [];
        // Absolute winding number is the number of times the curve winds around the center, where the sign is ignored
        const absWindingNumbers = [];
        const [centerX, centerY] = center;

        for (let i = 0; i < track.length - 1; i++) {
            const [x1, y1, t1] = track[i];
            const [x2, y2, t2] = track[i + 1];

            // vectors pointing from the center to the points
            const vec1 = [x1 - centerX, y1 - centerY];
            const vec2 = [x2 - centerX, y2 - centerY];

            const timeElapsed = t2 - t1;
            console.assert(timeElapsed >= 0, `Negative time elapsed between points ${i} and ${i + 1}`)
            // Angle between vec1 and vec2
            const angle = Math.atan2(vec2[1], vec2[0]) - Math.atan2(vec1[1], vec1[0]);

            // Correct for crossing the -PI to PI boundary
            const correctedAngle = angle >= Math.PI ? angle - 2 * Math.PI : (angle <= -Math.PI ? angle + 2 * Math.PI : angle);

            totalAngle += correctedAngle;

            if (timeElapsed === 0) {
                // No time should mean that the points are the same
                console.assert(correctedAngle === 0, `Angle ${correctedAngle} is non-zero for zero time elapsed`)
                angularVelocities.push(0); // Avoid division by zero, assuming stationary if no time has passed

            } else {
                // Calculate angular velocity as angle change per unit of time
                const angularVelocity = correctedAngle / timeElapsed;
                angularVelocities.push(angularVelocity);
            }
            relWindingNumbers.push((totalAngle - startAngle) / (2 * Math.PI));
            if (absWindingNumbers.length > 0) {
                absWindingNumbers.push(absWindingNumbers[absWindingNumbers.length - 1] + Math.abs(correctedAngle / (2 * Math.PI)));
            } else {
                absWindingNumbers.push(Math.abs(correctedAngle / (2 * Math.PI)));
            }
        }

        // Winding number is total angle divided by 2*PI
        const windingNumber = totalAngle / (2 * Math.PI);
        return { windingNumber, angularVelocities, windingNumbers: relWindingNumbers, absWindingNumbers };
    }

    function findLapSegments(track) {
        let {windingNumber, angularVelocities, windingNumbers, absWindingNumbers} = calculateWindingNumberAndAngularVelocity(track, trackMap.center, trackMap.startAngle);
        // A lap: starts and ends at the same angle on the track, and has a winding number of +/-1
        // Let's segment the abs winding number into chunks incrementing by 1
        let lapIndices = [0];
        let complete = [];
        let direction = [];
        let windingTarget = 1;
        for (let i = 1; i < absWindingNumbers.length; i++) {
            const absWindingNumber = absWindingNumbers[i];
            const lapWinding = windingNumbers[i] - windingNumbers[lapIndices[lapIndices.length - 1]];
            const lapAbsWinding = absWindingNumber - absWindingNumbers[lapIndices[lapIndices.length - 1]];
            if (windingTarget - lapAbsWinding < 0) {
                // We've returned to the start angle
                lapIndices.push(i);
                // Check if the winding number of this chunk is up/down by 1
                const isComplete = windingTarget - Math.abs(lapWinding) < 0;
                complete.push(isComplete);
                direction.push(lapWinding < 0);
            }
        }

        return [lapIndices, complete, direction];
    }

    let expandRow = function (row) {
        let detailsContainer = row.getElement()?.querySelector("lap-table")
        if (!detailsContainer.classList.contains("initialized")) {
            // Tabulator and Vega won't render correctly unless the parent element is visible
            const data = row.getData()
            // FIXME: This needs to be reactive to track changes
            if (!data.track) {
                return
            }
            const [lapIndices, complete, lapClockwise] = findLapSegments(data.track)
            const lapTrack = lapIndices.map((start, i) => {
                const end = i + 1 < lapIndices.length ? lapIndices[i + 1] : data.track.length - 1
                return data.track.slice(start, end)
            })
            const lapTime = lapTrack.map((lap) => lap[lap.length - 1][2] - lap[0][2])
            // First lap is long
            const lapLength = Array(lapTrack.length).fill(loopDistance)
            lapLength[0] = startDistances[bibToEvent(data.bib)] + loopDistance
            const detailData = {
                lapLength,
                lapTrack,
                complete,
                lapClockwise,
                lapTime
            }
            detailsContainer.addResultsDetails(detailData, goalLaps[bibToEvent(data.bib)]).then(() => {
                row.getTable().redraw()
            })
            detailsContainer.classList.add("initialized")
        } else {
            row.getTable().redraw()
        }
    }

    function addLapTableFormatter(row,e) {
        // The formatter gets called every refresh it seems...
        let rowElement = row.getElement()
        rowElement.bib = `#result-${row.getData().bib}`
        if (rowElement.querySelector("lap-table")) {
            return
        }
        let detailFragment = new LapTable()
        //create and style holder elements
        const id = row.getData().bib
        detailFragment.setAttribute('id', "result-detail-" + id + "");
        detailFragment.setAttribute("hidden", "hidden")
        rowElement.appendChild(detailFragment);
    }

    function beginRegularRefreshing() {
        return setInterval(() => {
            const now = new Date()
            // Render out "last seen X ago" strings
            table.getRows().forEach((row) => {
                let data = row.getData()
                const userRow = tableData.find((row) => row.username === data.username)
                if (!data.track || data.track.length === 0) {
                    return
                }
                let lastSample = data.lastUpdated
                if (data.track.length > 0) {
                    // Assume the last sample is the most recent
                    lastSample = new Date(data.track[data.track.length - 1][2] * 1000)
                }
                userRow.freshness = (now - lastSample) / 1000

            })
        }, 1250);
    }
    let refreshInterval = null

    let tableData = [
    ]
    function addUser(data) {
        const username = data.username
        let startFreshness = Date.now() / 1000 - data.tst
        const lastUpdated = new Date(data.tst * 1000)
        // For the initial fetch we'll take the last point timestamp as our "last update" timestamp
        tableData.push({username: username, name: data.name, bib: data.tid, laps: null, freshness: startFreshness, track: null, lastUpdated: lastUpdated, trackRequested:false, accuracy: data.acc});
        /*if (user.face) {
            trackMap.updateMarker(user.tid, 'imageData', user.face)
        }*/

    }

    let table = new Tabulator("#lap-table", {
        reactiveData:true,
        data:tableData,
        selectable:false,
        layout:"fitDataFill",
        placeholder: "No laps today",
        columns:[
            {title:"Bib", field:"bib", formatter: (cell) => {
                let data = cell.getRow().getData()
                return `<div class='bib ${bibToEvent(data.bib)}'>${data.bib}</div>`
            }},
            {title:"Name", field:"name", formatter: (cell) => {
                let data = cell.getRow().getData()
                    return data["name"] ? data["name"] : data["username"]

                }},

            {title:"Laps", field:"laps",  formatter: cell => {
                if (cell.getValue()) {
                    return cell.getValue().toFixed(2)
                } else {
                    return ""
                }

                }},
            {title:"Last Seen", field: "freshness",  formatter: (cell) => {
                let data = cell.getRow().getData()
                let freshness = data["freshness"]
                    const accuracyWarning = data["accuracy"] > 23 ? ` <span class="text-warning">⚠️</span>` : ""
                if (freshness === -1) {
                    return ""
                } else {
                    return formatTimeSince(Math.ceil(freshness)) + accuracyWarning
                }
            }},
            {title: "trackRequested", field: "trackRequested", visible: false},
        ],
        rowFormatter: addLapTableFormatter
    });

    function excludeTest(data, filterParams) {
        return data.bib[0] !== "E"
    }
    function excludeFull(data, filterParams) {
        return bibToEvent(data.bib) !== 'full'
    }
    function excludeHalf(data, filterParams) {
        return bibToEvent(data.bib) !== 'half'
    }

    function aliveToday(data, filterParams) {
        return data.lastUpdated > thisMorning
    }
    const filterManager = document.querySelector("table-filter-manager")
    filterManager.table = table
    filterManager.filters = {excludeTest, excludeFull, excludeHalf}


    table.on("dataChanged", function(data){
        // Think of the map as a reactive view of this table. Every time the data changes, we need to update the map
        // Tabulator doesn't correctly clear the placeholder on its own
        if (table.rowManager.getDisplayRows().length) {
            table.rowManager._clearPlaceholder();
        }

        table.getRows().forEach((row) => {
            const data = row.getData()
            trackMap.updateMarker(data.bib, 'backgroundColor', bibToEvent(data.bib) === 'full' ? 'var(--branding-color)' : 'var(--branding-color-complement)' );
            trackMap.updateMarker(data.bib, 'point', data.track ? data.track[data.track.length - 1] : null)
            trackMap.updateMarker(data.bib, 'freshness', data.freshness);
            trackMap.updateMarker(data.bib, 'visible', table.rowManager.getVisibleRows().find((row) => row.getData().bib === data.bib))
            trackMap.updateMarker(data.bib, 'highlighted', data.highlighted)
        })

        trackMap.refreshMarkersSource()
        table.getRows().filter((row) => !row.getData().highlighted).forEach((row) => {row.getElement()?.querySelector("lap-table")?.setAttribute("hidden", "hidden");
            row.getElement().classList.remove("details-opened")
        })
        // Handle highlighted row
        const highlighted = table.getRows().filter((row) => row.getData().highlighted)
        highlighted.forEach((row) => {
            row.getElement()?.querySelector("lap-table")?.toggleAttribute("hidden");
            expandRow(row);
            row.getElement().classList.add("details-opened")
            if (row.getData().track) {
                trackMap.updateTrack(row.getData().track)
            }
        })
        if (!highlighted || highlighted.length === 0) {
            trackMap.updateTrack([])
        }

    });
    table.on("dataFiltered", function(filters, rows){
        tableData.forEach((row) => {
            trackMap.updateMarker(row.bib, 'visible', false)
        })
        rows.forEach((row) => {
            const data = tableData.find((data) => data.bib === row.getData().bib)
            // This row wasn't fetched earlier, so get it now
            if (data.lastUpdated > thisMorning && !data.trackRequested) {
                console.log("Requesting track for", data.username, "due to filterchange")
                updateWithFullTrack(data.username)
            }
            trackMap.updateMarker(data.bib, 'visible', true)
        })
    });
    table.on("rowClick", function(e, row) {
        // Disabled pending more testing
        return;
        if (!(e.target.classList.contains("tabulator-row") || e.target.classList.contains("tabulator-cell"))) {
            return
        }
        let data = row.getData()
        if (!data.highlighted) {
            table.getRows().forEach((row) => row.update({highlighted: false}))
            row.update({highlighted: true})
        } else {
            table.getRows().forEach((row) => row.update({highlighted: false}))
        }

        let currentHash = window.location.hash
        let newHash = `#result-${data.id}`
        const details = row.getElement().querySelector("lap-table")
        if (!details.attributes["hidden"]) {
            history.replaceState(undefined, undefined, newHash)
        } else if (currentHash === newHash) {
            history.replaceState(undefined, undefined, " ")
        }
    });


    const thisMorning = new Date();
    thisMorning.setHours(0, 0, 0, 0);
    let liveTracking = null
    let trackMap = document.querySelector("track-map")
    const liveBounds = [[
        [
            -122.306304,
            47.653457
        ],
        [
            -122.308144,
            47.656089
        ],
        [
            -122.310014,
            47.655436
        ],
        [
            -122.308154,
            47.652844
        ],
        [
            -122.306304,
            47.653457
        ]
    ]]

    const bounds = turf.polygon(JSON.parse(trackMap.getAttribute('data-bounds')));
    trackMap.addLiveBounds(liveBounds);


    function updateWithFullTrack(username) {
        const data = tableData.find((data) => data.username === username)
        data.trackRequested = true
        return liveTracking.getLatestTrack(username, thisMorning).then((track) => {
            const filteredTrack = turf.pointsWithinPolygon(turf.points(track), bounds).features.map((feature) => {
                return feature.geometry.coordinates;
            })
            let freshness = data.freshness
            let laps = 0

            if (filteredTrack.length > 2) {
                const startTime = Date.now()
                const {
                    windingNumber,
                    angularVelocities,
                    windingNumbers,
                    absWindingNumbers
                } = calculateWindingNumberAndAngularVelocity(filteredTrack, trackMap.center, trackMap.startAngle);
                const endTime = Date.now()
                console.log(endTime - startTime)
                // Epoch time
                const latestStamp = track[track.length - 1][2];
                const currentStamp = Date.now() / 1000;
                freshness = currentStamp - latestStamp;
                laps = absWindingNumbers[absWindingNumbers.length - 1]
            } else {
                console.warn("Filtered track is too short", filteredTrack)
                console.warn("Original track", track.length)
            }
            data.track = filteredTrack
            data.laps = laps
            data.freshness = freshness
            data.lastUpdated = new Date()

            console.log("Updated", username)

        });
    }
    function initialize() {
        new p5(FountainToy("{{site.baseurl}}"), document.querySelector("#hero-toy .interactive"));

        // Tooltips for sign-up deadlines
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new Tooltip(tooltipTriggerEl))

        const connectionDot = document.querySelector("connection-dot")
        document.addEventListener("liveconnectionchange", (event) => {
            connectionDot.setAttribute("state", event.detail.state)
        });
        liveTracking = new LiveTrackingClient("drumhellerlive.nickwalker.us");
        document.addEventListener("livelocation", (event) => {
            const payload = event.detail
            let bib = payload.tid
            let userRow = tableData.find((row) => row.bib === bib)
            if (!userRow) {
                console.warn("Received location update for unknown user, fetching full track", bib)
                addUser(payload)
                updateWithFullTrack(payload.username)
                return
            }
            if (!payload.lon || !payload.lat || !payload.tst) {
                console.log("Received incomplete location update for", bib, payload)
                return
            }
            userRow.accuracy = payload.acc
            let point = [payload.lon, payload.lat, payload.tst]
            if (!userRow.trackRequested) {
                // The base track hasn't even been requested. Drop this location event
                return
            }
            if (!userRow.track) {
                userRow.track = []
            }
            userRow.track.push(point)
            userRow.lastUpdated = new Date()
            if (userRow.track.length > 2) {
                const {
                    windingNumber,
                    angularVelocities,
                    windingNumbers,
                    absWindingNumbers
                } = calculateWindingNumberAndAngularVelocity(userRow.track.slice(-2), trackMap.center, trackMap.startAngle);
                const increment = absWindingNumbers[absWindingNumbers.length - 1]
                if (increment === undefined) {
                    console.warn("Live update lap increment is undefined", userRow.track)
                } else {
                    userRow.laps += increment
                }
            }
            const freshness = Date.now() / 1000 - payload.tst
            userRow.freshness = freshness
        });
        liveTracking.getUsers().then((data) => {
            data.map(user => addUser(user))
            refreshInterval = beginRegularRefreshing()
            table.addFilter(aliveToday);
            liveTracking.enable()
        }).then(() => {

        });

    }
    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "visible") {
            Promise.all(table.rowManager.getVisibleRows().map((row) => {
                    console.log("Requesting track for", row.getData().username, "due to visibility change")
                    return updateWithFullTrack(row.getData().username)
            })).then(() => {
                console.log("All updated, starting regular refreshes")
                refreshInterval = beginRegularRefreshing()
                liveTracking.enable()
            })
            console.log("Page visible")

        } else {
            clearInterval(refreshInterval)
            liveTracking.disable()
            // Mark the tracks as stale so we re-request them when the page is visible again
            tableData.forEach((row) => {
                //console.log("Marking", row.username, "as stale")
                row.trackRequested = false
            })
            console.log("Page hidden")
        }
    });

    function setupLightboxes() {
        prepareImagesForPhotoswipe(document.querySelectorAll(".auto-lightbox")).then(() => {
            const lightbox = new PhotoSwipeLightbox({
                gallery: 'figure.gallery',
                children: 'a',
                showHideAnimationType: 'zoom',
                showAnimationDuration: 200,
                hideAnimationDuration: 200,
                pswpModule: () =>  import("photoswipe")
            });
            const captionPlugin = new PhotoSwipeDynamicCaption(lightbox, {
                type: 'auto',
                captionContent: (slide) => {
                    return slide.data.element.parentElement.querySelector("figcaption").innerHTML;
                }
            });

            lightbox.init();
        });
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initialize)
        document.addEventListener('DOMContentLoaded', e => setupLightboxes)
    } else {
        initialize()
        setupLightboxes()
    }
</script>

</body>
</html>
